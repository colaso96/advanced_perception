# CS 7180 Project 2 Shadow Removal: Assessing Shadow Removal as an Image Preprocessing Step to Enhance Classification Performance

## (Bronte) Sihan Li, Cole Crescas
### Submission: 2023-10-14
### Use time travel days: None

## Environment

Training tasks are run in a Linux environment with a CUDA GPU.

## Requirements

To install dependencies, run:

    pip install -r requirements.txt

We also use the ShadowAttack library from the paper [Shadows can be Dangerous: Stealthy and Effective Physical-world Adversarial Attack by Natural Phenomenon](https://arxiv.org/abs/2203.03818) with some modification. This is available on the project repo at [this link](https://github.com/bronteee/advanced-perception/tree/main/shadow-removal/ShadowAttack).

For shadow removal process, there is a ReadMe in the DC-ShadowNet-* folder that details how to setup the environment and folder strucutre for test data.  The data needs to be grouped to shadow and shadow free folders. 

## Data

For this project, we use the GTSRB dataset and applied shadow attacks on the test set to generate the shadowed images. The adversarial dataset can be downloaded [here](https://drive.google.com/file/d/187hUm28FJL3fHKEgpibwRaCE8b7_nFXg/view?usp=sharing). The shadowed images are generated by the `apply_shadow.ipynb` notebook.

## Pre-trained Model

A ResNet model trained on the GTSRB dataset is provided via this link [here](https://drive.google.com/file/d/1H2XrscM-aXEeTqqo8934gcKRiPard5W-/view?usp=sharing). The model is trained on the original GTSRB dataset without shadow attacks. To run a set of images on the trained model, run:

    python test_images.py --checkpoing_path <path_to_checkpoint> --test_dir <path_to_test_images>

We also used a pre-trained model for shadown removal on the AISTD and ISTD datasets.  More information in the readme in that folder.

## train_gtsrb_resnet.ipynb

This is the training notebook that defines and trains the ResNet model on the GTSRB dataset with a 80/20 train/validation split. The model is trained on the original GTSRB dataset without shadow attacks for 50 epoch, where the best validation accuracy was 99.9%. The results can be viewed [here](https://wandb.ai/fire-dream/gtsrb-resnet).

## apply_shadow.ipynb

This notebook is used to apply shadow attacks on the GTSRB test set. The shadow attacks are implemented using the [ShadowAttack library](https://github.com/bronteee/advanced-perception/tree/main/shadow-removal/ShadowAttack), where shadow polygons are drawn onto the images along with random adjustments of brightness and blur, the ideal location of the shadow is determined by a particle swarming optimization algorithm. The produced adversarial images are then processed into their respective labels.

## test_images.py

This script is used to test a set of images on the trained model. The script takes in a checkpoint path and a directory of images, and outputs the accuracy of the model on the images as well as a confusion matrix.
Usage:

    python test_images.py --checkpoing_path <path_to_checkpoint> --test_dir <path_to_test_images>

## helpers.py

This script contains multiple functions meant to be used as one off helper functions during data pre-processing.  Utilities include, moving files out of folders in a directory, changing the type of images and others. 

## pre_processing.py

This script filters data using color based shadow detection with a shadow threshold.  We used this to take unfiltered images into folders for testing and shadow removal.  After running this, the shadow removal model from this [link](https://github.com/jinyeying/DC-ShadowNet-Hard-and-Soft-Shadow-Removal) can be run for testing. 
